var hlparr={nbr:'<div class=mpds>сколько? \'валюта\' = 1</div><div class=pds><b>cn</b>jp = юань в йенах, <b>3</b>ru<b>eu</b> = 3 рубля в евро и т.д.<br> <b>dd</b> = дата, <b>cc</b> = отчистить</div>',ztm:'затем \'валюта\'',chya:'чья валюта?',vch:'в чью пересчитать?'},btn=document.getElementsByClassName('num'),cnt=document.getElementsByClassName('cnt'),tbl=document.getElementById('tbl'),v=document.getElementById('v'),clr=document.getElementById('clr'),wnd=document.getElementById('wnd'),hlp=document.getElementById('hlp'),dat=document.getElementById('dat'),seg=document.getElementById('seg'),curs,cursV,anch,epi=keyadd=data=chsl=msc=gd=hshv=!1,sklk=curs_1=curs_1V=Vtxt=1,morenum=0,msc=['января','февраля','марта','апреля','мая','июня','июля','августа','сентября','октября','ноября','декабря'],bbarr={
'md':MDL,'by':BYN,'ua':UAH,'ch':CHF,'uk':GBP,'tr':TRY,'us':USD,'ru':RUB,'eu':EUR,'in':INR,'cn':CNY,'jp':JPY,'dd':dat,'cc':clr,'kz':KZT,'am':AMD,'cp':wnd},digarr={48:'0',49:1,50:2,51:3,52:4,53:5,54:6,55:7,56:8,57:9,190:'.',188:'.',96:'0',97:1,98:2,99:3,100:4,101:5,102:6,103:7,104:8,105:9,110:'.'
},keyarr={65:'a',66:'b',67:'c',68:'d',69:'e',70:'f',71:'g',72:'h',73:'i',74:'j',75:'k',76:'l',77:'m',78:'n',79:'o',80:'p',81:'q',82:'r',83:'s',84:'t',85:'u',86:'v',87:'w',88:'x',89:'y',90:'z',8:''}
for(var i=0;i<btn.length;i++)btn[i].addEventListener('click',addNum);
for(var i=0;i<cnt.length;i++)cnt[i].addEventListener('click',addCnt);
v.addEventListener('click',addVal);
clr.addEventListener('click',clear);
dat.addEventListener('click',adata);
wnd.addEventListener('click',getLnk);
hlp.innerHTML=hlparr.nbr;
hash();
window.captureEvents(Event.KEYDOWN);
window.onkeydown=function(e){
	if(!data&&!epi)addVal();
	if(e.which==8){
		delX();
		keyadd=!1;
		for(var i=0;i<cnt.length;i++)cnt[i].classList.remove('sel');
	}
	else if(digarr[e.which]&&!epi){
		if(data){
			if(!keyadd){
				keyadd=digarr[e.which];
				addX(digarr[e.which]);
				dataNum(1);
			}
			else{
				keyadd+=digarr[e.which]+'';
				dataNum(2);
			}
		}
		else if(!keyadd)addX(digarr[e.which]);
	}
	else if(keyarr[e.which]){
		if(!keyadd){
			addX(keyarr[e.which]);
			keyadd=keyarr[e.which];
			var sel=btnwrp.querySelectorAll('.cnt[cnt^="'+keyadd+'"]:not(.hld)');
			for(var i=0;i<sel.length;i++)sel[i].classList.add('sel');
		}
		else{
			if(bbarr[keyadd+keyarr[e.which]]){
				delX();
				bbarr[keyadd+keyarr[e.which]].click();
			}
			else delX();
			keyadd=!1;
			for(var i=0;i<cnt.length;i++)cnt[i].classList.remove('sel');
		}
	}
}
function cnthld(){
	var dz=btnwrp.querySelectorAll('.cnt:not(.hld)'),rnd=Math.floor(Math.random()*dz.length),dz1=dz[rnd].getAttribute('v'),dz2=dz[rnd].getAttribute('v2'),dz3=' <b class=pds>'+dz[rnd].getAttribute('cnt')+'</b>',pds='gr',more=['следующая?','ещё в одну?','ещё?','интересует '+dz1+'?'+dz3,'а '+dz1+'?'+dz3,'курс к '+dz2+'?'+dz3,'а к '+dz2+'?'+dz3,'возможно, '+dz1+'?'+dz3,'или курс к '+dz2+'?'+dz3];
	if(morenum==more.length-1)morenum=3;
	if(morenum>2)pds='"pds gr"';
	if(hshv)morenum=0;
	return'<div class='+pds+'>'+more[morenum++]+'</div>';
}
function getLnk(){
	hlp.innerHTML='<a id="url" contenteditable href="'+window.location+'">'+window.location+'</a>';
	var root=document.getElementById('url').firstChild,rng=document.createRange(),sel=window.getSelection();
	rng.setStart(root,0);
	rng.setEnd(root,root.length);
	sel.removeAllRanges();
	sel.addRange(rng);
	document.execCommand("copy");
	hlp.innerHTML='ссылка скопирована в буфер обмена';
}
function cursArr(V,dt){
/*	if(V==1||dt)var date='?d='+getdata(V,0,dt);
	else var date='';
	var xhr=new XMLHttpRequest();
	xhr.open('GET','curs.json'+date,!1);
	xhr.send(null);
	if(xhr.status!=200)hlp.innerHTML='ошибочка: '+xhr.status+': '+xhr.statusText;
	else return JSON.parse(xhr.responseText);

//Динамичный файл 'curs.json' заменил на демо-файлы '13-02-2018.json' и '16-02-2018.json'

*/
	var xhr=new XMLHttpRequest();
	if(V==1||dt) xhr.open('GET','json/13-02-2018.json',!1);
	else  xhr.open('GET','json/16-02-2018.json',!1);
	xhr.send(null);
	if(xhr.status!=200)hlp.innerHTML='ошибочка: '+xhr.status+': '+xhr.statusText;
	else return JSON.parse(xhr.responseText);
}
function getdata(V,fd,dt){
	var sb=0,date=new Date();
	if(dt){
		dt=dt.split('-');
		date.setFullYear(dt[2],dt[1]-1,dt[0]);
	}
	else if(date.getUTCHours()<13)date.setDate(date.getDate()-1);
	date.setDate(date.getDate()-V);
	if(date.getDay()==5)sb=1;
	else if(date.getDay()==0)sb=2;
	date.setDate(date.getDate()-sb);
	var dn=date.getDate(),ms=date.getMonth()+1,gd=date.getFullYear();
	if(dn<10&&!fd)dn='0'+dn;
	if(ms<10&&!fd)ms='0'+ms;
	if(fd==1)return dn+' '+msc[ms-1];
	else if(fd==2)return dn+' '+msc[ms-1]+' '+gd+' г.';
	else return dn+'-'+ms+'-'+gd;
}
function adata(){
	clr.click();
	grd.className='e4';
	data=!0;
	chsl=1;
	hlp.innerHTML='за какое число? 01-31';
}
function addNum(){
	if(!data){
		grd.className='e1';
		addX(this.innerText);
		hlp.innerHTML=hlparr.ztm;
	}
	else{
		if(!keyadd){
			addX(this.innerText);
			keyadd=this.innerText+'';
			dataNum(1);
		}
		else{
			keyadd+=this.innerText+'';
			dataNum(2);
		}
	}
}
function dataNum(x){
	var psn,corr=!0;
	if(x==2){
		delX();
		switch(chsl){
			case 1:if(Number(keyadd)<32){
				data=keyadd;
				chsl=2;
				psn='-го числа какого месяца? 01-12';
			}
			else corr=!1;
			break;
			case 2:if(Number(keyadd)<13){
				data+='-'+keyadd;
				chsl=3;
				psn=' '+msc[Number(keyadd)-1]+' какого года? 01-18';
			}
			else corr=!1;
			break;
			case 3:if(Number(keyadd)<19){
				data+='-20'+keyadd;
				var dt=data;
				clear();
				curs=cursArr(0,dt);
				cursV=cursArr(0,0);
				anch=dt+':';
				window.location.hash=anch;
				seg.innerHTML=getdata(0,2,dt);
				corr=!1;
				break;
			}
			else corr=!1;
		default:keyadd=!1;
		}
		if(corr)hlp.innerHTML=parseFloat(keyadd.replace(/\,/g,'.'))+psn;
		keyadd=!1;
	}
}
function addX(x){
	tbl.appendChild(document.createTextNode(x));
}
function delX(){
	if(tbl.childNodes.length>0&&tbl.lastChild.nodeType==3)tbl.lastChild.remove();
}
function hash(){
	hshv=!0;
	var hsh=window.location.hash,d=0;
	if(hsh){
		var cn=hsh.match(/([0-9\-]{0,10})\:([0-9\.]*)([a-z]*)/i)||hsh.match(/(\#?)([0-9\.]*)([a-z]*)/i);
		if(cn[1]=='#'||!cn[1])d=0;
		else d=cn[1],anch=cn[1]+':';
	}
	if (d) curs=cursArr(0,d),cursV=cursArr(0,0);
	else curs=cursArr(0,0),cursV=cursArr(1,0);
	if(hsh){
		tbl.innerText=cn[2];
		for(var i=0;i<cn[3].length;i=i+2)if(bbarr[cn[3][i]+cn[3][i+1]])bbarr[cn[3][i]+cn[3][i+1]].click();
	}
	if(d)seg.innerHTML=getdata(0,2,d);
	hshv=!1;
}
function addCnt(){
	if(!this.matches('.hld')){
		this.classList+=' hld';
		if(!epi){
			grd.className='e2';
			epi=!0;
			sklk=Number(tbl.innerText)||1;
			if(anch)anch+=Number(tbl.innerText)||1;
			else anch=Number(tbl.innerText)||1;
			if(sklk==1)tbl.innerText='';
			curs_1=curs[this.id];
			curs_1V=cursV[this.id];
			var rvn=this.innerHTML+'&zwj;';
			hlp.innerHTML=hlparr.vch;
			Vtxt=this.getAttribute('v2');
		}
		else{
			grd.className='e3';
			var curs_2=curs_1/curs[this.id],
				curs_2V=curs_1V/cursV[this.id],
				curs_3=curs_2*sklk,
				curs_3V=curs_2V*sklk,
				curs_R;
			if(!curs_2||!curs_2V)var rvn='=<br><sml>нет данных</sml>'+this.innerHTML,curs_R=', нет данных о динамике';
			else{
				var	rvn='=<br>'+fix(curs_3)+this.innerHTML,mr='';
				if(curs_2==curs_2V) curs_R='курс без изменений';
				else if(curs_2>curs_2V) curs_R='<nw>▲ '+fix(((curs_2-curs_2V)/curs_2) * 100)+'%</nw> к '+fix(curs_3V);
				else curs_R='<nw>▼ -'+fix(((curs_2V-curs_2)/curs_2) * 100)+'%</nw> от '+fix(curs_3V);
			}
			if(document.getElementsByClassName('hld').length<cnt.length)mr=cnthld();
			else mr='<div><a href="/">заработай на разнице курсов</a></div>';
			hlp.innerHTML=this.getAttribute('v')+' к '+Vtxt+' '+curs_R+mr;
			delX();
		}
		keyadd=!1;
		tbl.innerHTML+=rvn;
		anch+=this.getAttribute('cnt');
		window.location.hash=anch;
		for(var i=0;i<cnt.length;i++)cnt[i].classList.remove('sel');
	}
}
function addVal(){
	grd.className='e2';
	hlp.innerHTML=hlparr.chya;
}
function clear(){
	tbl.innerHTML=tbl.classList=anch=window.location.hash=seg.innerHTML='';
	grd.className='e0';
	epi=keyadd=data=chsl=!1;
	sklk=1;
	morenum=0;
	hlp.innerHTML=hlparr.nbr;
	curs=cursArr(0,0);
	cursV=cursArr(1,0);
	var hld=document.getElementsByClassName('cnt');
	for(var i=0;i<hld.length;i++)hld[i].classList.remove('hld');
	for(var i=0;i<cnt.length;i++)cnt[i].classList.remove('sel');
}
function fix(crs){
	crs=Math.abs(crs);
	switch(!0){
		case(crs>1000):crs=crs.toFixed();break;
		case(crs>100):crs=crs.toFixed(1);break;
		case(crs>10):crs=crs.toFixed(2);break;
		case(crs>1):crs=crs.toFixed(3);break;
		case(crs>.1):crs=crs.toFixed(4);break;
		case(crs>.01):crs=crs.toFixed(5);break;
		default:crs=crs.toFixed(6);break;
	}
	return parseFloat(crs.replace(/\,/g,'.'));
}
